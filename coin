import os
import datetime
import time
import threading
import json
import math
import requests
import websocket # é€™è£¡å°å…¥çš„æ˜¯ websocket-client åº«ä¸­çš„ websocket æ¨¡çµ„
from flask import Flask, request, jsonify
from flask_cors import CORS
from dotenv import load_dotenv # å¼•å…¥ dotenv åº«ä¾†åŠ è¼‰ .env æ–‡ä»¶
import re # ç¢ºä¿åœ¨å…¨å±€ç¯„åœå°å…¥ re æ¨¡çµ„

# åŠ è¼‰ .env æ–‡ä»¶ä¸­çš„ç’°å¢ƒè®Šæ•¸ã€‚é€™æ‡‰è©²åœ¨å…¶ä»–ç’°å¢ƒè®Šæ•¸ä½¿ç”¨ä¹‹å‰åŸ·è¡Œã€‚
load_dotenv()

app = Flask(__name__)
CORS(app) # å…è¨±è·¨åŸŸè«‹æ±‚ã€‚å¦‚æœæ‚¨ä»¥å¾Œæœ‰ç¶²é å‰ç«¯ï¼Œå¯ä»¥è€ƒæ…®é™åˆ¶ç‰¹å®šä¾†æºã€‚

# ==== Telegram è¨­å®š (å¾ç’°å¢ƒè®Šæ•¸ç²å–ï¼Œæ›´å®‰å…¨ä¸”éˆæ´») ====
# è«‹ç¢ºä¿åœ¨éƒ¨ç½²ç’°å¢ƒä¸­è¨­å®šäº† TELEGRAM_BOT_TOKEN å’Œ TELEGRAM_CHAT_ID ç’°å¢ƒè®Šæ•¸
# ç‚ºäº†æ‚¨çš„æ–¹ä¾¿ï¼Œæˆ‘æš«æ™‚å°‡æ‚¨æä¾›çš„çœŸå¯¦å€¼ä½œç‚º os.getenv çš„é è¨­å€¼ã€‚
# ä½†åœ¨æ­£å¼éƒ¨ç½²æ™‚ï¼Œå¼·çƒˆå»ºè­°ä¸è¦åœ¨ä»£ç¢¼ä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè€Œæ˜¯åƒ…ä¾è³´ç’°å¢ƒè®Šæ•¸ã€‚
# å¦‚æœç’°å¢ƒè®Šæ•¸æœªè¨­ç½®ï¼Œé€™è£¡çš„é è¨­å€¼å°‡è¢«ä½¿ç”¨ã€‚
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', '6005276002:AAGN9u1k7xEmfwpe6nkJqhOPjsEwGttJGzM')
TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID', '-4946614597')

# =======================================================

# **** æ–°å¢ï¼šå®šç¾© UTC+8 æ™‚å€ ****
TAIPEI_TZ = datetime.timezone(datetime.timedelta(hours=8))

# ========== å…¨åŸŸè®Šæ•¸å’Œç›£æ§ç‹€æ…‹ ==========
SYMBOLS_TO_MONITOR = [] # ç›£æ§çš„äº¤æ˜“å°åˆ—è¡¨ï¼Œå•Ÿå‹•æ™‚å‹•æ…‹ç²å–
MONITORING_ACTIVE = False # ç›£æ§æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ

# æ­·å²æ•¸æ“šå„²å­˜ï¼š
# {
#   symbol: {
#     'spot': [{timestamp, value, volume}],
#     'futures': [{timestamp, value}],
#     'last_telegram_alert_time': datetime.datetime, // ä¸Šæ¬¡ç™¼é€ Telegram è­¦å ±çš„æ™‚é–“ (æ•´é«”å†·å»)
#     'telegram_alerts_history': [{ timestamp: datetime.datetime, type: 'price'/'oi', stars: int }], // å­˜å„²æ™‚é–“æˆ³å’Œé¡å‹ï¼Œç”¨æ–¼ç´¯è¨ˆå’Œåˆ¤æ–·æœ€é«˜æ˜Ÿç´š
#     'last_alert_times': { 'price': datetime.datetime, 'oi': datetime.datetime }, // å„é¡å‹è­¦å ±çš„å…§éƒ¨å†·å»æ™‚é–“ (é¿å…åŒä¸€é¡å‹çŸ­æ™‚é–“å…§é‡è¤‡è¨ˆå…¥ç´¯ç©)
#     'first_alert_trigger_time': datetime.datetime // æœ¬æ¬¡ç´¯è¨ˆè­¦å ±é€±æœŸçš„é¦–æ¬¡è§¸ç™¼æ™‚é–“
#   }
# }
history = {}
current_prices = {}
current_open_interests = {}
current_volumes = {}

# IP å°é–ç‹€æ…‹è¿½è¹¤
is_ip_banned = False
ban_until = 0 # å°é–è§£é™¤æ™‚é–“æˆ³ (æ¯«ç§’) - ç”¨æ–¼åˆ¤æ–·ä½•æ™‚è§£å°

# å®šç¾©è­¦å ±é–¾å€¼ (èˆ‡å‰ç«¯é‚è¼¯ä¿æŒä¸€è‡´)
PRICE_TIERS = [
    {'threshold': 5.0, 'rating': 'â­â­â­â­'},
    {'threshold': 4.0, 'rating': 'â­â­â­'},
    {'threshold': 3.0, 'rating': 'â­â­'},
    {'threshold': 2.0, 'rating': 'â­'}
]
OI_TIERS = [
    {'threshold': 5.0, 'rating': 'ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥'},
    {'threshold': 3.5, 'rating': 'ğŸ”¥ğŸ”¥ğŸ”¥'},
    {'threshold': 3.0, 'rating': 'ğŸ”¥ğŸ”¥'},
    {'threshold': 2.5, 'rating': 'ğŸ”¥'}
]

TELEGRAM_ALERT_COOLDOWN_MINUTES = 5 # Telegram è­¦å ±å†·å»æ™‚é–“ (åˆ†é˜)
CUMULATIVE_ALERT_WINDOW_MINUTES = 60 # ç´¯è¨ˆè­¦å ±çµ±è¨ˆçª—å£ (åˆ†é˜)
MIN_TELEGRAM_ALERT_STARS = 2 # è§¸ç™¼ Telegram è­¦å ±çš„æœ€ä½æ˜Ÿç´š
MIN_CUMULATIVE_ALERTS = 3 # è§¸ç™¼ Telegram è­¦å ±çš„æœ€ä½ç´¯è¨ˆæ¬¡æ•¸

MIN_VOLUME_MULTIPLIER = 1.5 # åƒ¹æ ¼è®Šå‹•è‡³å°‘éœ€è¦å‰ä¸€æ ¹ K ç·š 1.5 å€çš„æˆäº¤é‡
HIGH_VOLUME_MULTIPLIER = 2.0 # åƒ¹æ ¼è®Šå‹•æˆäº¤é‡è¶…é 2 å€ï¼Œè©•ç´šæœƒæ›´é«˜

HOURLY_REMINDER_INTERVAL_SECONDS = 3600 # æ¯å°æ™‚æé†’ (3600 ç§’ = 1 å°æ™‚)
LAST_HOURLY_REMINDER_TIME = 0 # ä¸Šæ¬¡ç™¼é€æ¯å°æ™‚æé†’çš„æ™‚é–“æˆ³

# WebSocket å®¢æˆ¶ç«¯å¯¦ä¾‹
spot_ws_client = None

# ========== è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—ç™¾åˆ†æ¯”è®Šå‹• ==========
def calculate_percentage_change(data_array, minutes):
    now = datetime.datetime.now(TAIPEI_TZ) # ä½¿ç”¨ UTC+8 æ™‚é–“
    cutoff_time = now - datetime.timedelta(minutes=minutes)

    old_val = None
    # å¾æ•¸æ“šé™£åˆ—çš„æœ«å°¾é–‹å§‹éæ­·ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘æˆ–æ—©æ–¼æˆªæ­¢æ™‚é–“çš„æ•¸æ“šé»
    for item in reversed(data_array):
        if item['timestamp'] <= cutoff_time:
            old_val = item['value']
            break

    new_val = data_array[-1]['value'] if data_array else None

    if old_val is None or new_val is None or old_val == 0:
        return None

    return ((new_val - old_val) / old_val) * 100

def check_volume_condition(spot_data_array, minutes):
    now = datetime.datetime.now(TAIPEI_TZ) # ä½¿ç”¨ UTC+8 æ™‚é–“
    cutoff_time = now - datetime.timedelta(minutes=minutes)

    # æ‰¾åˆ°è©²æ™‚é–“ç¯„åœçš„èµ·å§‹é»
    current_period_data = [item for item in spot_data_array if item['timestamp'] >= cutoff_time]
    
    if not current_period_data:
        return None

    current_period_volume = sum(item.get('volume', 0) for item in current_period_data)

    # æ‰¾åˆ° cutoff_time ä¹‹å‰æœ€è¿‘çš„ä¸€æ ¹ K ç·šçš„æˆäº¤é‡ä½œç‚ºåŸºæº–
    prev_candle_volume = None
    for item in reversed(spot_data_array):
        if item['timestamp'] < cutoff_time and 'volume' in item:
            prev_candle_volume = item['volume']
            break
    
    if prev_candle_volume is None or prev_candle_volume == 0 or current_period_volume == 0:
        return None

    volume_multiplier = current_period_volume / prev_candle_volume
    return volume_multiplier

def get_rating_info(value, tiers, volume_multiplier=0):
    abs_value = abs(value)
    rating_info = next((tier for tier in tiers if abs_value >= tier['threshold']), None)
    
    if rating_info:
        stars = len(rating_info['rating']) // 2
        rating_text = rating_info['rating']

        # å¦‚æœæ˜¯åƒ¹æ ¼è®Šå‹•ï¼Œä¸¦ä¸”æˆäº¤é‡å€æ•¸é«˜æ–¼é–¾å€¼ï¼Œå‰‡æå‡æ˜Ÿç´š
        if tiers == PRICE_TIERS and volume_multiplier >= HIGH_VOLUME_MULTIPLIER:
            stars = min(stars + 1, 4) # æœ€å¤šæå‡åˆ° 4 æ˜Ÿ
            rating_text = 'â­' * stars

            return {
                'rating': rating_text,
                'stars': stars
            }
        return {'rating': '', 'stars': 0}

    # ========== Telegram è­¦å ±ç™¼é€å‡½æ•¸ ==========
    def send_telegram_alert(message):
        global TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID

        if not TELEGRAM_BOT_TOKEN or TELEGRAM_BOT_TOKEN == '6005276002:AAGN9u1k7xEmfwpe6nkJqhOPjsEwGttJGzM':
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] éŒ¯èª¤ï¼šTelegram Bot Token æœªæ­£ç¢ºè¨­å®šæˆ–ç‚ºé è¨­å€¼ã€‚è«‹æª¢æŸ¥ .env æ–‡ä»¶æˆ–ç’°å¢ƒè®Šæ•¸ã€‚")
            return False # è¿”å› False è¡¨ç¤ºç™¼é€å¤±æ•—
        
        if not TELEGRAM_CHAT_ID or TELEGRAM_CHAT_ID == '-4946614597':
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] éŒ¯èª¤ï¼šTelegram Chat ID æœªæ­£ç¢ºè¨­å®šæˆ–ç‚ºé è¨­å€¼ã€‚è«‹æª¢æŸ¥ .env æ–‡ä»¶æˆ–ç’°å¢ƒè®Šæ•¸ã€‚")
            return False

        telegram_url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
        payload = {
            "chat_id": TELEGRAM_CHAT_ID,
            "text": message,
            "parse_mode": "HTML"
        }

        try:
            response = requests.post(telegram_url, json=payload, timeout=10) # è¨­ç½®è¶…æ™‚
            response.raise_for_status() # å¦‚æœéŸ¿æ‡‰ç‹€æ…‹ç¢¼æ˜¯ 4xx æˆ– 5xxï¼Œå‰‡æ‹‹å‡ºç•°å¸¸
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] Telegram è­¦å ±ç™¼é€æˆåŠŸã€‚")
            return True # è¿”å› True è¡¨ç¤ºç™¼é€æˆåŠŸ
        except requests.exceptions.Timeout:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] éŒ¯èª¤ï¼šTelegram API è«‹æ±‚è¶…æ™‚ã€‚")
            return False
        except requests.exceptions.RequestException as e:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] éŒ¯èª¤ï¼šç™¼é€ Telegram è­¦å ±å¤±æ•—ï¼š{e}")
            return False

    # **** æ–°å¢ï¼šæ¯å°æ™‚æé†’å‡½æ•¸ ****
    def send_hourly_reminder():
        global LAST_HOURLY_REMINDER_TIME
        # ä½¿ç”¨ç·šç¨‹å®‰å…¨çš„æ–¹å¼æ›´æ–°æ™‚é–“
        current_timestamp = time.time()
        if current_timestamp - LAST_HOURLY_REMINDER_TIME >= HOURLY_REMINDER_INTERVAL_SECONDS:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [æé†’] å˜—è©¦ç™¼é€æ¯å°æ™‚æé†’...")
            success = send_telegram_alert(f"ğŸ¤– æ©Ÿå™¨äººé‹è¡Œä¸­... (UTC+8: {datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')})")
            if success: # åªæœ‰æˆåŠŸç™¼é€æ‰æ›´æ–°æ™‚é–“ï¼Œé¿å…å› å¤±æ•—è€Œé »ç¹ç™¼é€
                LAST_HOURLY_REMINDER_TIME = current_timestamp
            
        # é‡æ–°å®‰æ’ä¸‹ä¸€æ¬¡æª¢æŸ¥ (ä¾‹å¦‚æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦åˆ°ä¸€å°æ™‚)
        # threading.Timer æœƒå‰µå»ºä¸€å€‹æ–°ç·šç¨‹ï¼Œæ‰€ä»¥é€™æ˜¯ä¸€å€‹æŒçºŒçš„å¾Œå°ä»»å‹™
        threading.Timer(60, send_hourly_reminder).start()


    # ========== Binance API æ•¸æ“šç²å– ==========

    # WebSocket äº‹ä»¶è™•ç†å‡½æ•¸
    def on_message(ws, message):
        data = json.loads(message)
        if isinstance(data, list): # !ticker@arr è¿”å›ä¸€å€‹åˆ—è¡¨
            for item in data:
                symbol_raw = item.get('s')
                if symbol_raw:
                    # å¹£å®‰è¿”å›çš„åƒ¹æ ¼å’Œæˆäº¤é‡æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦è½‰æ›ç‚ºæµ®é»æ•¸
                    price = float(item.get('c', '0'))
                    volume = float(item.get('v', '0')) # 24h æˆäº¤é‡

                    formatted_symbol = symbol_raw.replace('USDT', '/USDT')

                    if formatted_symbol in SYMBOLS_TO_MONITOR:
                        now = datetime.datetime.now(TAIPEI_TZ) # ä½¿ç”¨ UTC+8 æ™‚é–“
                        current_prices[formatted_symbol] = price
                        current_volumes[formatted_symbol] = volume

                        if formatted_symbol not in history: # ç¢ºä¿ history å­—å…¸å­˜åœ¨
                            history[formatted_symbol] = {
                                'spot': [],
                                'futures': [],
                                'last_telegram_alert_time': None,
                                'telegram_alerts_history': [],
                                'last_alert_times': {'price': None, 'oi': None},
                                'first_alert_trigger_time': None
                            }

                        history[formatted_symbol]['spot'].append({'timestamp': now, 'value': price, 'volume': volume})

                        # æ¸…ç†èˆŠæ•¸æ“š (åªä¿ç•™æœ€è¿‘ 16 åˆ†é˜ï¼Œä»¥ç¢ºä¿ 15 åˆ†é˜è¨ˆç®—æœ‰è¶³å¤ æ•¸æ“š)
                        cutoff = now - datetime.timedelta(minutes=16)
                        history[formatted_symbol]['spot'] = [
                            d for d in history[formatted_symbol]['spot'] if d['timestamp'] >= cutoff
                        ]
        # else:
        #     print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] WS Message (éåˆ—è¡¨æ¶ˆæ¯): {data}") # æ‰“å°éåˆ—è¡¨æ¶ˆæ¯ï¼Œä¾‹å¦‚ ping/pong

    def on_error(ws, error):
        global is_ip_banned, ban_until
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] å¹£å®‰ç¾è²¨ WebSocket éŒ¯èª¤: {error}")
        # æª¢æŸ¥æ˜¯å¦ç‚º IP å°é–éŒ¯èª¤ (Binance WS ä¸ç›´æ¥è¿”å› HTTP ç‹€æ…‹ç¢¼ï¼Œä½†å¯èƒ½æœƒåœ¨éŒ¯èª¤è¨Šæ¯ä¸­æç¤º)
        error_str = str(error).lower()
        if "ban" in error_str or "too many requests" in error_str or "429" in error_str:
            is_ip_banned = True
            # ç°¡å–®ä¼°è¨ˆå°é–æ™‚é–“ï¼Œå¯¦éš›æƒ…æ³å¯èƒ½æ›´è¤‡é›œï¼Œé€™è£¡å‡è¨­å°é– 5 åˆ†é˜
            ban_until = datetime.datetime.now().timestamp() * 1000 + 5 * 60 * 1000 
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] IP å·²è¢«å°é– (WebSocket æª¢æ¸¬åˆ°)ã€‚å°‡åœ¨ {datetime.datetime.fromtimestamp(ban_until/1000).strftime('%Y-%m-%d %H:%M:%S')} (UTC+8) å¾Œé‡è©¦ã€‚")
        ws.close() # éŒ¯èª¤å¾Œé—œé–‰é€£æ¥ï¼Œè§¸ç™¼ on_close é‡æ–°é€£æ¥

    def on_close(ws, close_status_code, close_msg):
        global spot_ws_client
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] å¹£å®‰ç¾è²¨ WebSocket å·²é—œé–‰: ç‹€æ…‹ç¢¼={close_status_code}, è¨Šæ¯={close_msg}ã€‚æ­£åœ¨å˜—è©¦é‡æ–°é€£æ¥...")
        # åªæœ‰åœ¨ç›£æ§æ´»èºä¸” IP æœªè¢«å°é–æˆ–å°é–å·²éæœŸæ™‚æ‰å˜—è©¦è‡ªå‹•é‡é€£
        if MONITORING_ACTIVE and (not is_ip_banned or datetime.datetime.now().timestamp() * 1000 >= ban_until):
            time.sleep(5) # ç­‰å¾…5ç§’å¾Œé‡é€£
            start_spot_websocket_client() # é‡æ–°å•Ÿå‹• WebSocket
        elif not MONITORING_ACTIVE:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] ç›£æ§å·²åœæ­¢ï¼Œä¸å†å˜—è©¦ WebSocket é‡é€£ã€‚")
        else: # IP ä»è¢«å°é–
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] IP ä»è¢«å°é–ï¼Œæš«åœ WebSocket è‡ªå‹•é‡é€£ã€‚")


    def on_open(ws):
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] å¹£å®‰ç¾è²¨ WebSocket å·²é€£æ¥ã€‚")
        # **** æ–°å¢ï¼šå•Ÿå‹•æç¤ºè© ****
        send_telegram_alert(f"ğŸš€ æ©Ÿå™¨äººå·²å•Ÿå‹•ä¸¦é–‹å§‹ç›£æ§ï¼(UTC+8: {datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')})")


    def start_spot_websocket_client():
        global spot_ws_client, is_ip_banned, ban_until
        if is_ip_banned and datetime.datetime.now().timestamp() * 1000 < ban_until:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] IP ä»è¢«å°é–ã€‚è·³é WebSocket é‡é€£ï¼Œç›´åˆ° {datetime.datetime.fromtimestamp(ban_until/1000).strftime('%Y-%m-%d %H:%M:%S')} (UTC+8)ã€‚")
            return

        # å¦‚æœå·²ç¶“æœ‰ WebSocket é€£ç·šï¼Œå…ˆé—œé–‰å®ƒ
        if spot_ws_client and spot_ws_client.sock and spot_ws_client.sock.connected:
            spot_ws_client.close()
            time.sleep(1) # çµ¦é»æ™‚é–“è®“å®ƒé—œé–‰

        websocket_url = "wss://stream.binance.com:9443/ws/!ticker@arr" # 24h ticker for volume
        try:
            # å‰µå»º WebSocketApp å¯¦ä¾‹
            spot_ws_client = websocket.WebSocketApp(
                websocket_url,
                on_open=on_open,
                on_message=on_message,
                on_error=on_error,
                on_close=on_close
            )
            # åœ¨ç¨ç«‹ç·šç¨‹ä¸­é‹è¡Œ WebSocketï¼Œé˜²æ­¢é˜»å¡ä¸»ç·šç¨‹æˆ– Flask æ‡‰ç”¨
            # daemon=True ç¢ºä¿ä¸»ç¨‹å¼é€€å‡ºæ™‚ï¼Œé€™å€‹ç·šç¨‹ä¹Ÿæœƒè¢«çµ‚æ­¢
            threading.Thread(target=spot_ws_client.run_forever, daemon=True).start()
        except Exception as e:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] éŒ¯èª¤ï¼šå•Ÿå‹• WebSocket å®¢æˆ¶ç«¯å¤±æ•—: {e}")
            # å¦‚æœå•Ÿå‹•å¤±æ•—ï¼Œéä¸€æ®µæ™‚é–“å¾Œé‡è©¦
            if MONITORING_ACTIVE:
                time.sleep(10)
                start_spot_websocket_client()


    def retry_fetch(url, retries=3, delay=1000):
        global is_ip_banned, ban_until
        
        for i in range(retries):
            current_timestamp_ms = datetime.datetime.now().timestamp() * 1000
            if is_ip_banned and current_timestamp_ms < ban_until:
                wait_time_seconds = max(5, (ban_until - current_timestamp_ms) / 1000 + 1)
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] IP ä»è¢«å°é–ã€‚è·³é {url} ç²å–ï¼Œå°‡ç­‰å¾… {wait_time_seconds:.2f} ç§’ç›´åˆ° {datetime.datetime.fromtimestamp(ban_until/1000).strftime('%Y-%m-%d %H:%M:%S')} (UTC+8)ã€‚")
                time.sleep(wait_time_seconds)
                continue # ç­‰å¾…çµæŸå¾Œå†æ¬¡å˜—è©¦ï¼Œè€Œä¸æ˜¯ç›´æ¥è·³éæœ¬æ¬¡å¾ªç’°

            try:
                response = requests.get(url, timeout=10) # è¨­ç½®è¶…æ™‚
                response.raise_for_status() # å¦‚æœéŸ¿æ‡‰ç‹€æ…‹ç¢¼æ˜¯ 4xx æˆ– 5xxï¼Œå‰‡æ‹‹å‡ºç•°å¸¸
                return response.json()
            except requests.exceptions.HTTPError as http_err:
                error_text = response.text
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] ç²å–å˜—è©¦ {i + 1} å¤±æ•—ï¼š{url} ç‹€æ…‹ç¢¼ {response.status_code}: {error_text}")
                if response.status_code == 418 or ("-1003" in error_text and "banned" in error_text):
                    is_ip_banned = True
                    match = re.search(r"banned until (\d+)", error_text)
                    if match:
                        ban_until = int(match.group(1)) # å¾éŒ¯èª¤è¨Šæ¯ä¸­è§£ææ™‚é–“æˆ³
                    else:
                        ban_until = datetime.datetime.now().timestamp() * 1000 + 5 * 60 * 1000 # é è¨­å°é– 5 åˆ†é˜
                    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] IP å·²è¢«å°é– (REST API æª¢æ¸¬åˆ°)ã€‚å°‡åœ¨ {datetime.datetime.fromtimestamp(ban_until/1000).strftime('%Y-%m-%d %H:%M:%S')} (UTC+8) å¾Œé‡è©¦ã€‚")
                    raise Exception(f"IP BANNED: {error_text}") # æ‹‹å‡ºç•°å¸¸ä»¥åœæ­¢é€²ä¸€æ­¥é‡è©¦
                else:
                    if i < retries - 1:
                        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] å°‡åœ¨ {delay * (2**i) / 1000} ç§’å¾Œé‡è©¦...")
                        time.sleep(delay * (2**i) / 1000)
                    else:
                        raise # æœ€å¾Œä¸€æ¬¡å˜—è©¦å¤±æ•—ï¼Œé‡æ–°æ‹‹å‡ºç•°å¸¸
            except requests.exceptions.RequestException as req_err:
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] ç²å–å˜—è©¦ {i + 1} é‡åˆ°ç¶²çµ¡éŒ¯èª¤ï¼š{url}: {req_err}")
                if i < retries - 1:
                    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] å°‡åœ¨ {delay * (2**i) / 1000} ç§’å¾Œé‡è©¦...")
                    time.sleep(delay * (2**i) / 1000)
                else:
                    raise # æœ€å¾Œä¸€æ¬¡å˜—è©¦å¤±æ•—ï¼Œé‡æ–°æ‹‹å‡ºç•°å¸¸

        raise Exception(f"åœ¨ {retries} æ¬¡å˜—è©¦å¾Œä»ç„¡æ³•ç²å– {url}ã€‚")

    def fetch_open_interest_rest():
        global SYMBOLS_TO_MONITOR, is_ip_banned, ban_until
        
        current_timestamp_ms = datetime.datetime.now().timestamp() * 1000
        if is_ip_banned and current_timestamp_ms < ban_until:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] IP ä»è¢« REST API å°é–ã€‚è·³é OI ç²å–ã€‚")
            return

        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] æ­£åœ¨é€šé REST API ç²å–æœŸè²¨æŒå€‰é‡...")
        delay_between_requests = 0.5 # æ¯å€‹äº¤æ˜“å°è«‹æ±‚é–“éš” 500 æ¯«ç§’

        # ä½¿ç”¨ list(SYMBOLS_TO_MONITOR) å‰µå»ºå‰¯æœ¬ï¼Œä»¥é˜²åœ¨å¾ªç’°ä¸­åˆ—è¡¨è¢«ä¿®æ”¹
        for symbol in list(SYMBOLS_TO_MONITOR): 
            current_timestamp_ms = datetime.datetime.now().timestamp() * 1000
            if is_ip_banned and current_timestamp_ms < ban_until:
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] åœ¨ OI ç²å–éç¨‹ä¸­ IP è¢«å°é–ã€‚åœæ­¢å¾ªç’°ã€‚")
                break

            binance_symbol = symbol.replace('/', '')
            url = f"https://fapi.binance.com/fapi/v1/openInterest?symbol={binance_symbol}"
            try:
                data = retry_fetch(url)
                open_interest = float(data.get('openInterest', '0')) # ç¢ºä¿å¾å­—ç¬¦ä¸²è½‰æ›

                if not math.isnan(open_interest):
                    now = datetime.datetime.now(TAIPEI_TZ) # ä½¿ç”¨ UTC+8 æ™‚é–“
                    current_open_interests[symbol] = open_interest
                    if symbol not in history: # ç¢ºä¿ history å­—å…¸å­˜åœ¨
                        history[symbol] = {
                            'spot': [],
                            'futures': [],
                            'last_telegram_alert_time': None,
                            'telegram_alerts_history': [],
                            'last_alert_times': {'price': None, 'oi': None},
                            'first_alert_trigger_time': None
                        }
                    history[symbol]['futures'].append({'timestamp': now, 'value': open_interest})

                    cutoff = now - datetime.timedelta(minutes=16)
                    history[symbol]['futures'] = [
                        d for d in history[symbol]['futures'] if d['timestamp'] >= cutoff
                    ]
                else:
                    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] è­¦å‘Šï¼šç„¡æ³•è§£æ {symbol} çš„æŒå€‰é‡æ•¸æ“š: {data}")

            except Exception as e:
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] éŒ¯èª¤ï¼šç²å– {symbol} æŒå€‰é‡å¤±æ•—: {e}")
                if "IP BANNED" in str(e):
                    break # å¦‚æœ IP è¢«å°é–ï¼Œåœæ­¢ç•¶å‰ OI ç²å–å¾ªç’°
                # å¦‚æœæ˜¯ -4108 éŒ¯èª¤ (Symbol is on delivering...)ï¼Œå‰‡å°‡è©²ç¬¦è™Ÿå¾ç›£æ§åˆ—è¡¨ä¸­ç§»é™¤
                if "-4108" in str(e) and "Symbol is on delivering" in str(e):
                    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] è¨Šæ¯ï¼šäº¤æ˜“å° {symbol} ç‹€æ…‹ç„¡æ•ˆï¼Œå°‡å¾ç›£æ§åˆ—è¡¨ä¸­ç§»é™¤ã€‚")
                    SYMBOLS_TO_MONITOR = [s for s in SYMBOLS_TO_MONITOR if s != symbol]
                    history.pop(symbol, None)
                    current_prices.pop(symbol, None)
                    current_open_interests.pop(symbol, None)
                    current_volumes.pop(symbol, None)
            
            time.sleep(delay_between_requests) # æ¯å€‹è«‹æ±‚ä¹‹é–“ç¨ä½œå»¶é²


    # ========== è­¦å ±é‚è¼¯è™•ç† ==========
    def check_and_send_alerts_logic():
        global is_ip_banned, ban_until
        now = datetime.datetime.now(TAIPEI_TZ) # ä½¿ç”¨ UTC+8 æ™‚é–“

        # å¦‚æœ IP è¢«å°é–ä¸”æœªåˆ°è§£å°æ™‚é–“ï¼Œå‰‡ä¸åŸ·è¡Œè­¦å ±æª¢æŸ¥å’Œç™¼é€
        if is_ip_banned and now.timestamp() * 1000 < ban_until:
            print(f"[{now.strftime('%Y-%m-%d %H:%M:%S')}] ç›£æ§æš«åœï¼šIP ä»è¢«å°é–ï¼Œç›´åˆ° {datetime.datetime.fromtimestamp(ban_until/1000).strftime('%Y-%m-%d %H:%M:%S')} (UTC+8)ã€‚")
            return

        # æª¢æŸ¥æ˜¯å¦å·²éæœŸï¼Œå¦‚æœéæœŸå‰‡è§£é™¤å°é–ç‹€æ…‹
        if is_ip_banned and now.timestamp() * 1000 >= ban_until:
            is_ip_banned = False
            ban_until = 0
            print(f"[{now.strftime('%Y-%m-%d %H:%M:%S')}] IP å°é–å¯èƒ½å·²è§£é™¤ã€‚æ­£åœ¨æ¢å¾©ç›£æ§ã€‚")


        # éæ­·ç›£æ§ä¸­çš„äº¤æ˜“å°ï¼Œä½¿ç”¨ list() å‰µå»ºå‰¯æœ¬ä»¥é˜²æ­¢åœ¨å¾ªç’°ä¸­ä¿®æ”¹åŸå§‹åˆ—è¡¨
        for symbol in list(SYMBOLS_TO_MONITOR): 
            if symbol not in history:
                continue # å¯èƒ½æ˜¯å› ç‚ºè©²ç¬¦è™Ÿå·²è¢«ç§»é™¤

            symbol_history = history[symbol]
            spot_hist = symbol_history['spot']
            fut_hist = symbol_history['futures']

            # ç¢ºä¿æœ‰è¶³å¤ çš„æ•¸æ“šé€²è¡Œè¨ˆç®—
            if len(spot_hist) < 2 or len(fut_hist) < 2:
                # print(f"[{now.strftime('%Y-%m-%d %H:%M:%S')}] è¨Šæ¯ï¼š{symbol} æ²’æœ‰è¶³å¤ çš„æ­·å²æ•¸æ“šä¾†è¨ˆç®—è®Šå‹•ã€‚")
                continue

            p1 = calculate_percentage_change(spot_hist, 1)
            p5 = calculate_percentage_change(spot_hist, 5)
            p15 = calculate_percentage_change(spot_hist, 15)

            o1 = calculate_percentage_change(fut_hist, 1)
            o5 = calculate_percentage_change(fut_hist, 5)
            o15 = calculate_percentage_change(fut_hist, 15)

            # è¨ˆç®—æˆäº¤é‡å€æ•¸
            v1_multiplier = check_volume_condition(spot_hist, 1)
            v5_multiplier = check_volume_condition(spot_hist, 5)
            v15_multiplier = check_volume_condition(spot_hist, 15)
            
            # ç²å–åƒ¹æ ¼è©•ç´šè³‡è¨Šæ™‚ï¼Œè€ƒæ…®æˆäº¤é‡å€æ•¸
            # ä½¿ç”¨ max(..., 0) ç¢ºä¿å³ä½¿æŸå€‹è®Šå‹•ç‚º Noneï¼Œä¹Ÿä¸å½±éŸ¿å–æœ€å¤§å€¼
            symbol_history['priceRatingInfo'] = get_rating_info(
                max(abs(p) if p is not None else 0 for p in [p1, p5, p15]),
                PRICE_TIERS,
                max(v_m if v_m is not None else 0 for v_m in [v1_multiplier, v5_multiplier, v15_multiplier])
            )

            # ç²å– OI è©•ç´šè³‡è¨Š
            symbol_history['oiRatingInfo'] = get_rating_info(
                max(abs(o) if o is not None else 0 for o in [o1, o5, o15]),
                OI_TIERS
            )

            # åƒ¹æ ¼è­¦å ±é¡å¤–æ¢ä»¶ï¼šå¿…é ˆæ»¿è¶³æˆäº¤é‡éæ¿¾
            qualified_price_alert = False
            # åªæœ‰ç•¶åƒ¹æ ¼è©•ç´šæ˜Ÿç´šå¤§æ–¼ 0 æ™‚ï¼Œæ‰é€²ä¸€æ­¥åˆ¤æ–·æˆäº¤é‡æ¢ä»¶
            if symbol_history['priceRatingInfo']['stars'] > 0: 
                # ä¿®æ­£ Python ä¸­çš„é‚è¼¯æˆ–é‹ç®—ç¬¦ `or`
                if ((p1 is not None and abs(p1) >= PRICE_TIERS[-1]['threshold'] and v1_multiplier is not None and v1_multiplier >= MIN_VOLUME_MULTIPLIER) or 
                    (p5 is not None and abs(p5) >= PRICE_TIERS[-1]['threshold'] and v5_multiplier is not None and v5_multiplier >= MIN_VOLUME_MULTIPLIER) or 
                    (p15 is not None and abs(p15) >= PRICE_TIERS[-1]['threshold'] and v15_multiplier is not None and v15_multiplier >= MIN_VOLUME_MULTIPLIER)):
                    qualified_price_alert = True
            
            # OI è®Šå‹•åªéœ€è¦æ»¿è¶³åŸºç¤é–¾å€¼ï¼ˆæ˜Ÿç´šå¤§æ–¼ 0ï¼‰
            oi_alert_threshold_met = symbol_history['oiRatingInfo']['stars'] > 0

            # æ›´æ–°ç´¯è¨ˆè­¦å ±è¨ˆæ•¸ (éæ¿¾æ‰è¶…å‡ºæ™‚é–“çª—çš„èˆŠè­¦å ±)
            symbol_history['telegram_alerts_history'] = [
                entry for entry in symbol_history['telegram_alerts_history']
                if (now - entry['timestamp']).total_seconds() / 60 < CUMULATIVE_ALERT_WINDOW_MINUTES
            ]

            # å¦‚æœç´¯è¨ˆæ­·å²è¢«æ¸…ç©º (è¡¨ç¤ºé€²å…¥æ–°çš„ç´¯è¨ˆé€±æœŸ)ï¼Œå‰‡é‡ç½®é¦–æ¬¡è§¸ç™¼æ™‚é–“
            if not symbol_history['telegram_alerts_history']:
                symbol_history['first_alert_trigger_time'] = None

            # åˆ¤æ–·æ˜¯å¦æœ‰æ–°çš„é¡¯è‘—è­¦å ±è§¸ç™¼ï¼Œä¸¦æ·»åŠ åˆ°æ­·å²è¨˜éŒ„ä¸­
            new_significant_alert_occurred = False

            # æª¢æŸ¥åƒ¹æ ¼è­¦å ±æ˜¯å¦ç¬¦åˆè³‡æ ¼ä¸¦æ·»åŠ åˆ°æ­·å²
            if qualified_price_alert and symbol_history['priceRatingInfo']['stars'] >= MIN_TELEGRAM_ALERT_STARS:
                last_price_alert_time = symbol_history['last_alert_times']['price']
                if not last_price_alert_time or (now - last_price_alert_time).total_seconds() / 60 >= TELEGRAM_ALERT_COOLDOWN_MINUTES:
                    symbol_history['telegram_alerts_history'].append({'timestamp': now, 'type': 'price', 'stars': symbol_history['priceRatingInfo']['stars']})
                    symbol_history['last_alert_times']['price'] = now # æ›´æ–°åƒ¹æ ¼è­¦å ±çš„ä¸Šæ¬¡è§¸ç™¼æ™‚é–“
                    new_significant_alert_occurred = True

            # æª¢æŸ¥ OI è­¦å ±æ˜¯å¦ç¬¦åˆè³‡æ ¼ä¸¦æ·»åŠ åˆ°æ­·å²
            if oi_alert_threshold_met and symbol_history['oiRatingInfo']['stars'] >= MIN_TELEGRAM_ALERT_STARS:
                last_oi_alert_time = symbol_history['last_alert_times']['oi']
                if not last_oi_alert_time or (now - last_oi_alert_time).total_seconds() / 60 >= TELEGRAM_ALERT_COOLDOWN_MINUTES:
                    symbol_history['telegram_alerts_history'].append({'timestamp': now, 'type': 'oi', 'stars': symbol_history['oiRatingInfo']['stars']})
                    symbol_history['last_alert_times']['oi'] = now # æ›´æ–° OI è­¦å ±çš„ä¸Šæ¬¡è§¸ç™¼æ™‚é–“
                    new_significant_alert_occurred = True

            # å¦‚æœæœ‰æ–°çš„é¡¯è‘—è­¦å ±è§¸ç™¼ï¼Œä¸”é¦–æ¬¡è§¸ç™¼æ™‚é–“å°šæœªè¨­å®šï¼Œå‰‡è¨­å®šå®ƒ
            if new_significant_alert_occurred and symbol_history['first_alert_trigger_time'] is None:
                symbol_history['first_alert_trigger_time'] = now

            # æ±ºå®šæ˜¯å¦ç™¼é€ Telegram è­¦å ±
            should_send_telegram_alert = (
                len(symbol_history['telegram_alerts_history']) >= MIN_CUMULATIVE_ALERTS and
                (symbol_history['priceRatingInfo']['stars'] >= MIN_TELEGRAM_ALERT_STARS or
                 symbol_history['oiRatingInfo']['stars'] >= MIN_TELEGRAM_ALERT_STARS)
            )
            
            # Telegram ç¸½é«”å†·å»æ™‚é–“ (é¿å…é »ç¹ç™¼é€)
            last_telegram_sent_time = symbol_history['last_telegram_alert_time']
            on_overall_telegram_cooldown = last_telegram_sent_time and \
                                           (now - last_telegram_sent_time).total_seconds() / 60 < TELEGRAM_ALERT_COOLDOWN_MINUTES

            if should_send_telegram_alert and not on_overall_telegram_cooldown:
                base_symbol = symbol.split('/')[0]
                telegram_message = f"#{base_symbol} {symbol}\n\n"
                
                # æ·»åŠ é¦–æ¬¡è§¸ç™¼æ™‚é–“
                if symbol_history['first_alert_trigger_time']:
                    first_trigger_formatted = symbol_history['first_alert_trigger_time'].strftime("%Y-%m-%d %H:%M:%S")
                    telegram_message += f"é¦–æ¬¡è§¸ç™¼æ™‚é–“: {first_trigger_formatted}\n\n"

                telegram_message += f"{symbol} å·²åœ¨ {CUMULATIVE_ALERT_WINDOW_MINUTES} åˆ†é˜å…§ç´¯è¨ˆ {len(symbol_history['telegram_alerts_history'])} æ¬¡è­¦ç¤ºã€‚\n\n"
                
                telegram_message += "è­¦ç¤ºè¨˜éŒ„ (æ™‚é–“ - é¡å‹ - è©•ç´š):\n"
                # æŒ‰ç…§æ™‚é–“é †åºé¡¯ç¤ºæ­·å²è­¦å ± (ç¢ºä¿åªé¡¯ç¤ºå”¯ä¸€çš„æ™‚é–“é»é¡å‹çµ„åˆ)
                unique_alerts_tuples = sorted(
                    list(set(
                        (entry['timestamp'].strftime("%Y%m%d%H%M%S"), entry['type'], entry['stars']) 
                        for entry in symbol_history['telegram_alerts_history']
                    )), 
                    key=lambda x: datetime.datetime.strptime(x[0], "%Y%m%d%H%M%S")
                )

                for entry_tuple in unique_alerts_tuples:
                    ts_str, type_str, stars_num = entry_tuple
                    entry_time = datetime.datetime.strptime(ts_str, "%Y%m%d%H%M%S").strftime("%H:%M:%S")
                    type_emoji = 'ğŸ“ˆ' if type_str == 'price' else 'ğŸ’¹'
                    type_text = 'åƒ¹æ ¼' if type_str == 'price' else 'æŒå€‰é‡'
                    stars = 'â­' * stars_num
                    telegram_message += f"  â€¢ {entry_time} - {type_emoji} {type_text} {stars}\n"

                telegram_message += f"\n--- ç•¶å‰ç•°å‹•è©³æƒ… ({now.strftime('%H:%M:%S')}) ---\n"
                
                # åƒ¹æ ¼è®Šå‹•è©³æƒ…
                if qualified_price_alert:
                    stars_rating = symbol_history['priceRatingInfo']['rating']
                    telegram_message += f"ğŸ“ˆ åƒ¹æ ¼ç•°å‹• {stars_rating}è©•ç´š\n"
                    telegram_message += f"  â€¢ 1m: {p1:.2f}%" if p1 is not None else "N/A"
                    telegram_message += f" | 5m: {p5:.2f}%" if p5 is not None else "N/A"
                    telegram_message += f" | 15m: {p15:.2f}%" if p15 is not None else "N/A"
                    telegram_message += "\n"
                    telegram_message += f"  â€¢ æˆäº¤é‡å€æ•¸ (1m/5m/15m): "
                    telegram_message += f"{v1_multiplier:.2f}x" if v1_multiplier is not None else "N/A"
                    telegram_message += f" / {v5_multiplier:.2f}x" if v5_multiplier is not None else "N/A"
                    telegram_message += f" / {v15_multiplier:.2f}x" if v15_multiplier is not None else "N/A"
                    telegram_message += "\n"

                # æŒå€‰é‡è®Šå‹•è©³æƒ…
                if oi_alert_threshold_met:
                    fires_rating = symbol_history['oiRatingInfo']['rating']
                    oi_relation_note = ''
                    is_price_up = (p1 is not None and p1 > 0) or (p5 is not None and p5 > 0) or (p15 is not None and p15 > 0)
                    is_price_down = (p1 is not None and p1 < 0) or (p5 is not None and p5 < 0) or (p15 is not None and p15 < 0)
                    is_oi_up = (o1 is not None and o1 > 0) or (o5 is not None and o5 > 0) or (o15 is not None and o15 > 0)
                    is_oi_down = (o1 is not None and o1 < 0) or (o5 is not None and o5 < 0) or (o15 is not None and o15 < 0)

                    if is_oi_up and is_price_up:
                        oi_relation_note = " (å¤šæ–¹è¶¨å‹¢éå›º)" # OI & Price UP
                    elif is_oi_down and is_price_down:
                        oi_relation_note = " (ç©ºæ–¹è¶¨å‹¢éå›º)" # OI & Price DOWN
                    elif is_oi_up and is_price_down:
                        oi_relation_note = " âš ï¸ ç–‘æ˜¯ç©ºæ–¹é€²å ´" # OI UP & Price DOWN (ç©ºé ­æŒå€‰å¢åŠ ï¼Œåƒ¹æ ¼ä¸‹è·Œ)
                    elif is_oi_down and is_price_up:
                        oi_relation_note = " âš ï¸ ç–‘æ˜¯å¤šæ–¹æ’¤é€€" # OI DOWN & Price UP (å¤šé ­å¹³å€‰ï¼Œåƒ¹æ ¼ä¸Šæ¼²ä¹åŠ›)
                    elif is_oi_up and not is_price_up and not is_price_down:
                        oi_relation_note = " (æŒå€‰é‡å¢åŠ ï¼Œåƒ¹æ ¼ç›¤æ•´)"
                    elif is_oi_down and not is_price_up and not is_price_down:
                        oi_relation_note = " (æŒå€‰é‡æ¸›å°‘ï¼Œåƒ¹æ ¼ç›¤æ•´)"

                    telegram_message += f"ğŸ’¹ æŒå€‰ç•°å‹• {fires_rating}{oi_relation_note}\n"
                    telegram_message += f"  â€¢ 1m: {o1:.2f}%" if o1 is not None else "N/A"
                    telegram_message += f" | 5m: {o5:.2f}%" if o5 is not None else "N/A"
                    telegram_message += f" | 15m: {o15:.2f}%" if o15 is not None else "N/A"
                    telegram_message += "\n"
                
                hot_symbol_tag = ''
                if symbol_history['priceRatingInfo']['stars'] >= 4 or symbol_history['oiRatingInfo']['stars'] >= 4:
                    hot_symbol_tag = 'ğŸ”¥ å¤§ç†±æ¨™çš„ ğŸ”¥'
                    telegram_message += f"\n{hot_symbol_tag}\n"
                
                send_telegram_alert(telegram_message)
                symbol_history['last_telegram_alert_time'] = now


    # ========== ç›£æ§ä¸»å¾ªç’° (å¾Œå°é‹è¡Œé‚è¼¯) ==========
    def monitor_main_loop():
        global SYMBOLS_TO_MONITOR, MONITORING_ACTIVE, is_ip_banned, ban_until

        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] å•Ÿå‹•ç›£æ§ä¸»å¾ªç’°...")
        
        # åˆå§‹åŒ–äº¤æ˜“å°åˆ—è¡¨
        try:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] æª¢æŸ¥IPå°é–ç‹€æ…‹ä¸¦ç²å–åˆå§‹äº¤æ˜“å°åˆ—è¡¨...")
            current_timestamp_ms = datetime.datetime.now().timestamp() * 1000
            if is_ip_banned and current_timestamp_ms < ban_until:
                wait_time_seconds = max(5, (ban_until - current_timestamp_ms) / 1000 + 1)
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] IP ä»è¢«å°é–ã€‚è·³éåˆå§‹äº¤æ˜“å°ç²å–ï¼Œå°‡ç­‰å¾… {wait_time_seconds:.2f} ç§’ã€‚")
                time.sleep(wait_time_seconds)
            
            if is_ip_banned and datetime.datetime.now().timestamp() * 1000 >= ban_until:
                is_ip_banned = False
                ban_until = 0
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] IP å°é–æ™‚é–“å·²éï¼Œé‡ç½®å°é–ç‹€æ…‹ã€‚")


            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] æ­£åœ¨ç²å–å¯ç›£æ§çš„æœŸè²¨äº¤æ˜“å°åˆ—è¡¨...")
            exchange_info = retry_fetch('https://fapi.binance.com/fapi/v1/exchangeInfo')
            valid_symbols = [
                s['symbol'].replace('USDT', '/USDT')
                for s in exchange_info['symbols']
                if s['quoteAsset'] == 'USDT' and s['contractType'] == 'PERPETUAL' and s['status'] == 'TRADING'
            ]
            SYMBOLS_TO_MONITOR = valid_symbols
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] å·²è¼‰å…¥ {len(SYMBOLS_TO_MONITOR)} å€‹æœŸè²¨äº¤æ˜“å°ã€‚")

            if not SYMBOLS_TO_MONITOR:
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] æ²’æœ‰å¯ç›£æ§çš„äº¤æ˜“å°ã€‚ç›£æ§å°‡åœæ­¢ã€‚")
                MONITORING_ACTIVE = False
                return # æ²’æœ‰äº¤æ˜“å°ï¼Œç›´æ¥é€€å‡ºç›£æ§å¾ªç’°
            
            # åˆå§‹åŒ– history æ•¸æ“šçµæ§‹
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] åˆå§‹åŒ–æ­·å²æ•¸æ“šçµæ§‹...")
            for symbol in SYMBOLS_TO_MONITOR:
                history[symbol] = {
                    'spot': [],
                    'futures': [],
                    'last_telegram_alert_time': None,
                    'telegram_alerts_history': [],
                    'last_alert_times': {'price': None, 'oi': None},
                    'first_alert_trigger_time': None
                }
                current_prices[symbol] = 0
                current_open_interests[symbol] = 0
                current_volumes[symbol] = 0

        except Exception as e:
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] éŒ¯èª¤ï¼šåˆå§‹äº¤æ˜“å°ç²å–å¤±æ•—: {e}")
            if "IP BANNED" in str(e):
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] IP åœ¨äº¤æ˜“å°ç²å–æ™‚è¢«å°é–ã€‚ç›£æ§å°‡åœ¨è§£å°å¾Œé‡è©¦ã€‚")
                time.sleep(10) # ç°¡çŸ­ä¼‘æ¯ä¸€ä¸‹å†è®“å®ƒé‡è©¦æ•´å€‹å¾ªç’°
                return monitor_main_loop() # éæ­¸èª¿ç”¨è‡ªèº«å˜—è©¦é‡å•Ÿ
            
            # å…¶ä»–éŒ¯èª¤ï¼Œå˜—è©¦åœ¨ä¸€æ®µæ™‚é–“å¾Œé‡è©¦æ•´å€‹åˆå§‹åŒ–æµç¨‹
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] åˆå§‹ç›£æ§è¨­ç½®å¤±æ•—ï¼Œå°‡åœ¨ 30 ç§’å¾Œé‡è©¦...")
            time.sleep(30)
            return monitor_main_loop() # éæ­¸èª¿ç”¨è‡ªèº«å˜—è©¦é‡å•Ÿ


        # å•Ÿå‹• WebSocket å®¢æˆ¶ç«¯
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] å•Ÿå‹• WebSocket å®¢æˆ¶ç«¯...")
        start_spot_websocket_client()

        # **** é¦–æ¬¡èª¿ç”¨æ¯å°æ™‚æé†’å‡½æ•¸ (å®ƒæœƒè‡ªå‹•å®‰æ’å¾ŒçºŒçš„åŸ·è¡Œ) ****
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] å®‰æ’æ¯å°æ™‚æé†’ä»»å‹™...")
        send_hourly_reminder()


        # ä¸»å¾ªç’°ï¼šå®šæœŸç²å– OI ä¸¦æª¢æŸ¥è­¦å ±
        while MONITORING_ACTIVE:
            try:
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] é–‹å§‹ç²å– OI ä¸¦æª¢æŸ¥è­¦å ±...")
                # å®šæœŸå¾ REST API ç²å–æœŸè²¨æŒå€‰é‡
                fetch_open_interest_rest()

                # æª¢æŸ¥ä¸¦ç™¼é€è­¦å ±
                check_and_send_alerts_logic() # èª¿ç”¨å¯¦éš›çš„è­¦å ±é‚è¼¯å‡½æ•¸

                # è¨ˆç®—ä¸‹ä¸€æ¬¡ OI ç²å–çš„å»¶é²
                # ç¢ºä¿æ¯æ¬¡å®Œæ•´çš„ OI ç²å–é€±æœŸè‡³å°‘æœ‰ 60 ç§’ï¼ˆ1 åˆ†é˜ï¼‰
                # æ¯å€‹äº¤æ˜“å°è«‹æ±‚é–“éš” 0.5sï¼Œæ‰€ä»¥ç¸½æ™‚é–“ = äº¤æ˜“å°æ•¸é‡ * 0.5s
                delay_for_all_oi_fetches = len(SYMBOLS_TO_MONITOR) * 0.5
                # å¯¦éš›ç¡çœ æ™‚é–“ï¼Œç¢ºä¿è‡³å°‘ 10 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œä½†ä¹Ÿè¦è€ƒæ…® OI ç²å–æ™‚é–“
                sleep_time = max(10, delay_for_all_oi_fetches) 

                # å¦‚æœ IP è¢«å°é–ï¼Œç­‰å¾…ç›´åˆ°è§£å°
                current_timestamp_ms = datetime.datetime.now().timestamp() * 1000
                if is_ip_banned and current_timestamp_ms < ban_until:
                    sleep_time = max(5, (ban_until - current_timestamp_ms) / 1000 + 1)
                    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] IP è¢«å°é–ã€‚ä¼‘çœ  {sleep_time:.2f} ç§’ã€‚")
                
                time.sleep(sleep_time)

            except Exception as e:
                print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] ç›£æ§ä¸»å¾ªç’°ä¸­ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼š{e}")
                if "IP BANNED" in str(e):
                     # IP å°é–éŒ¯èª¤å·²åœ¨ retry_fetch æˆ– on_error ä¸­è™•ç†ï¼Œé€™è£¡åªæ˜¯è¨˜éŒ„ä¸¦ç¹¼çºŒ
                     pass
                else:
                    # å…¶ä»–æ„å¤–éŒ¯èª¤ï¼Œç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡è©¦
                    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [ä¸»å¾ªç’°] ç›£æ§å¾ªç’°å°‡åœ¨ 10 ç§’å¾Œå› éŒ¯èª¤é‡å•Ÿ...")
                    time.sleep(10)

    # ========== Flask è·¯ç”± (ç”¨æ–¼å•Ÿå‹•/åœæ­¢ç›£æ§ï¼Œæˆ–æœªä¾†ç‹€æ…‹æŸ¥è©¢) ==========

    # è¨­ç½®ä¸€å€‹æ¨™èªŒï¼Œç¢ºä¿ç›£æ§ç·šç¨‹åªè¢«å•Ÿå‹•ä¸€æ¬¡
    # é€™å€‹æ¨™èªŒç¾åœ¨æ˜¯å…¨å±€çš„ï¼Œä¸¦ä¸”åœ¨ Gunicorn å•Ÿå‹•æ™‚è¢«è¨­ç½®
    monitoring_thread_started = False

    # **** Gunicorn å•Ÿå‹•æ™‚çš„é‰¤å­å‡½æ•¸ ****
    # é€™æ®µä»£ç¢¼åœ¨ Flask æ‡‰ç”¨è¢« Gunicorn å•Ÿå‹•æ™‚æœƒè¢«åŸ·è¡Œã€‚
    # å®ƒä½æ–¼å…¨å±€ä½œç”¨åŸŸï¼Œåœ¨ Flask app å°è±¡å‰µå»ºä¹‹å¾Œã€‚
    # é€™æ˜¯ç¢ºä¿å¾Œå°ç›£æ§é‚è¼¯åœ¨ Gunicorn ç’°å¢ƒä¸‹è‡ªå‹•å•Ÿå‹•çš„é—œéµã€‚
    print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [å…¨å±€å•Ÿå‹•] æ‡‰ç”¨å¯¦ä¾‹å‰µå»ºå®Œæˆï¼Œæª¢æŸ¥æ˜¯å¦å•Ÿå‹•ç›£æ§ç·šç¨‹...")
    if not monitoring_thread_started:
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [å…¨å±€å•Ÿå‹•] ç›£æ§ç·šç¨‹å°šæœªå•Ÿå‹•ï¼Œç¾åœ¨å•Ÿå‹•å®ƒã€‚")
        MONITORING_ACTIVE = True
        threading.Thread(target=monitor_main_loop, daemon=True).start()
        monitoring_thread_started = True
    else:
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [å…¨å±€å•Ÿå‹•] ç›£æ§ç·šç¨‹å·²å•Ÿå‹•ã€‚")

    @app.route('/start_monitoring', methods=['POST'])
    def start_monitoring_endpoint():
        global MONITORING_ACTIVE, monitoring_thread_started
        if not MONITORING_ACTIVE:
            MONITORING_ACTIVE = True
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [Flaskè·¯ç”±] è«‹æ±‚å•Ÿå‹•ç›£æ§æœå‹™ (é€šéAPI)ã€‚")
            # å¦‚æœç›£æ§ç·šç¨‹å°šæœªå•Ÿå‹•ï¼Œå‰‡åœ¨é€™è£¡å•Ÿå‹•å®ƒï¼ˆä»¥é˜² before_request æœªè§¸ç™¼æˆ–ç›£æ§åœæ­¢ï¼‰
            # æ³¨æ„ï¼šé€™è£¡çš„èª¿ç”¨é‚è¼¯éœ€è¦å°å¿ƒï¼Œé¿å…é‡è¤‡å•Ÿå‹•ç·šç¨‹
            if not monitoring_thread_started: # å¦‚æœç¬¬ä¸€æ¬¡å•Ÿå‹•å°±æ˜¯é€šéé€™å€‹API
                 threading.Thread(target=monitor_main_loop, daemon=True).start()
                 monitoring_thread_started = True
                 print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [Flaskè·¯ç”±] é€šéAPIå•Ÿå‹•äº†å¾Œå°ç›£æ§ç·šç¨‹ã€‚")

            return jsonify({"status": "success", "message": "ç›£æ§æœå‹™å·²åœ¨å¾Œå°å•Ÿå‹•ã€‚"}), 200
        return jsonify({"status": "info", "message": "ç›£æ§æœå‹™å·²åœ¨é‹è¡Œä¸­ã€‚"}), 200

    @app.route('/stop_monitoring', methods=['POST'])
    def stop_monitoring_endpoint():
        global MONITORING_ACTIVE, spot_ws_client, monitoring_thread_started
        if MONITORING_ACTIVE:
            MONITORING_ACTIVE = False
            monitoring_thread_started = False # é‡ç½®æ¨™èªŒ
            if spot_ws_client:
                spot_ws_client.close() # é—œé–‰ WebSocket é€£æ¥
                spot_ws_client = None # æ¸…ç†å¯¦ä¾‹
            print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [Flaskè·¯ç”±] è«‹æ±‚åœæ­¢ç›£æ§æœå‹™ã€‚")
            return jsonify({"status": "success", "message": "ç›£æ§æœå‹™å·²åœæ­¢ã€‚"}), 200
        return jsonify({"status": "info", "message": "ç›£æ§æœå‹™æœªé‹è¡Œã€‚"}), 200

    @app.route('/status', methods=['GET'])
    def get_status():
        global MONITORING_ACTIVE, is_ip_banned, ban_until
        
        ban_until_formatted = "N/A"
        if ban_until:
            try:
                ban_until_formatted = datetime.datetime.fromtimestamp(ban_until/1000).astimezone(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')
            except ValueError:
                ban_until_formatted = "Invalid Timestamp"

        status = {
            "monitoring_active": MONITORING_ACTIVE,
            "is_ip_banned": is_ip_banned,
            "ban_until": ban_until_formatted,
            "symbols_monitored": len(SYMBOLS_TO_MONITOR),
            "current_data_points_summary": {
                s: {
                    "spot_hist_len": len(history.get(s, {}).get('spot', [])), 
                    "futures_hist_len": len(history.get(s, {}).get('futures', []))
                } 
                for s in list(SYMBOLS_TO_MONITOR)[:5] # åªé¡¯ç¤ºå‰5å€‹ä»¥é˜²éé•·
            },
            "websocket_status": "Connected" if spot_ws_client and spot_ws_client.sock and spot_ws_client.sock.connected else "Disconnected"
        }
        return jsonify(status), 200


    # å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ (åƒ…åœ¨ç›´æ¥é‹è¡Œ app.py æ™‚åŸ·è¡Œ)
    if __name__ == '__main__':
        print(f"[{datetime.datetime.now(TAIPEI_TZ).strftime('%Y-%m-%d %H:%M:%S')}] [__main__] Flask æ‡‰ç”¨ä¸»å…¥å£ (ç›´æ¥é‹è¡Œæ¨¡å¼) å•Ÿå‹•ä¸­...")
        
        # åœ¨é–‹ç™¼æ¨¡å¼ä¸‹é‹è¡Œï¼Œæ–¹ä¾¿èª¿è©¦
        # åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œæ­¤è™•é€šå¸¸ç”± Gunicorn èª¿ç”¨ appï¼Œæ‰€ä»¥é€™æ®µä»£ç¢¼ä¸æœƒåŸ·è¡Œ
        # å› æ­¤ï¼Œæˆ‘å€‘å°‡å•Ÿå‹•é‚è¼¯ç§»åˆ°äº†å…¨å±€ä½œç”¨åŸŸï¼Œç¢ºä¿ Gunicorn æœƒåŸ·è¡Œå®ƒ
        app.run(host='0.0.0.0', port=5000, debug=False)
    ```

---

### **è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ›´æ–°ä¸¦é‡å•Ÿæœå‹™ï¼š**

1.  **ç™»å…¥æ‚¨çš„ä¼ºæœå™¨ SSHï¼Œä¸¦åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„ï¼š**
    ```bash
    ssh root@167.71.72.64
    cd /opt/crypto_bot
    ```

2.  **åœæ­¢æœå‹™ï¼š**
    ```bash
    sudo systemctl stop alertbot.service
    ```

3.  **ç·¨è¼¯ `app.py` æª”æ¡ˆï¼š**
    ```bash
    nano app.py
    ```
    å°‡ä¸Šé¢æä¾›çš„**æœ€æ–°ä¸”å®Œæ•´ç‰ˆ `app.py` ç¨‹å¼ç¢¼**ï¼Œ**å®Œæ•´è¤‡è£½ä¸¦è²¼å…¥**åˆ° `nano` ç·¨è¼¯å™¨ä¸­ã€‚

    **æœ€é—œéµçš„ä¿®æ”¹é»ï¼š**
    * **å°‡ `monitor_main_loop` ç·šç¨‹çš„å•Ÿå‹•é‚è¼¯ï¼Œä»¥åŠ `send_hourly_reminder()` çš„é¦–æ¬¡èª¿ç”¨ï¼Œç§»å‹•åˆ°äº† `app = Flask(__name__)` ä¹‹å¾Œï¼Œä½†åœ¨ä»»ä½•å‡½æ•¸å®šç¾©ä¹‹å¤–çš„å…¨å±€ä½œç”¨åŸŸã€‚** é€™æ¨£ï¼Œç•¶ `gunicorn` å°å…¥ `app.py` æ™‚ï¼Œé€™äº›ä»£ç¢¼å°±æœƒè¢«åŸ·è¡Œï¼Œå¾è€Œå•Ÿå‹•å¾Œå°ç›£æ§ã€‚
    * `if __name__ == '__main__':` å€å¡Šç¾åœ¨åªè² è²¬åœ¨ç›´æ¥é‹è¡Œ `python app.py` æ™‚å•Ÿå‹• Flask Web æœå‹™å™¨ã€‚

4.  **ä¿å­˜ä¸¦é€€å‡º `nano`ï¼š**
    * æŒ‰ä¸‹ `Ctrl` + `X`
    * è¼¸å…¥ `Y`
    * æŒ‰ `Enter`

5.  **é‡å•Ÿæœå‹™ï¼š**
    ```bash
    sudo systemctl restart alertbot.service
    ```

6.  **æŸ¥çœ‹å¯¦æ™‚æ—¥èªŒ (æœ€é‡è¦)ï¼š**
    ```bash
    sudo journalctl -u alertbot.service -f
    ```
    **è«‹å¯†åˆ‡è§€å¯Ÿæ—¥èªŒã€‚** é€™æ¬¡ï¼Œæ‚¨æ‡‰è©²èƒ½çœ‹åˆ°ä»¥ `[å…¨å±€å•Ÿå‹•]` é–‹é ­çš„æ—¥èªŒï¼Œç¢ºèªç›£æ§ç·šç¨‹å·²å•Ÿå‹•ã€‚

    * æ‚¨æ‡‰è©²åœ¨æ—¥èªŒçš„é–‹é ­çœ‹åˆ°ï¼š
        * `[å…¨å±€å•Ÿå‹•] æ‡‰ç”¨å¯¦ä¾‹å‰µå»ºå®Œæˆï¼Œæª¢æŸ¥æ˜¯å¦å•Ÿå‹•ç›£æ§ç·šç¨‹...`
        * `[å…¨å±€å•Ÿå‹•] ç›£æ§ç·šç¨‹å°šæœªå•Ÿå‹•ï¼Œç¾åœ¨å•Ÿå‹•å®ƒã€‚`
        * `[ä¸»å¾ªç’°] å•Ÿå‹•ç›£æ§ä¸»å¾ªç’°...`
        * `[ä¸»å¾ªç’°] æª¢æŸ¥IPå°é–ç‹€æ…‹ä¸¦ç²å–åˆå§‹äº¤æ˜“å°åˆ—è¡¨...`
        * `[ä¸»å¾ªç’°] å®‰æ’æ¯å°æ™‚æé†’ä»»å‹™...`
        * `å¹£å®‰ç¾è²¨ WebSocket å·²é€£æ¥ã€‚`
        * **ä¸¦ä¸”ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ‚¨æ‡‰è©²åœ¨æ—¥èªŒä¸­çœ‹åˆ° `Telegram è­¦å ±ç™¼é€æˆåŠŸã€‚`ï¼Œä¸¦åœ¨æ‚¨çš„ Telegram èŠå¤©å®¤ä¸­æ”¶åˆ°å•Ÿå‹•æç¤ºè¨Šæ¯ã€‚**

**è«‹æ‚¨å°‡ `sudo journalctl -u alertbot.service -f` çš„è¼¸å‡ºï¼ˆå¾æ‚¨é‡å•Ÿæœå‹™é‚£ä¸€åˆ»é–‹å§‹ï¼Œç›¡å¯èƒ½å¤šï¼Œç‰¹åˆ¥æ˜¯ä»»ä½•ç´…è‰²æ–‡å­—æˆ– Tracebackï¼‰æˆªåœ–çµ¦æˆ‘ã€‚** é€™æ¬¡ï¼Œæˆ‘å€‘æ‡‰è©²èƒ½çœ‹åˆ°æ ¸å¿ƒç›£æ§é‚è¼¯çš„å•Ÿå‹•æ—¥èªŒå’Œ Telegram è¨Šæ¯ç™¼é€ç‹€æ…‹äº†ï¼
